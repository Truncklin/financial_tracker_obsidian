---
view: monthly
categories:
  - "[[Переводы]]"
  - "[[Спорттовары]]"
  - "[[Тренировки]]"
  - "[[Супермаркеты]]"
  - "[[Фастфуд]]"
  - "[[Рестораны]]"
---

```dataviewjs
(async () => {
  // ----------------------------
  // выбранные категории
  // ----------------------------
  const selectedCatNames = dv.array(dv.current().categories)
    .map(c => c.path.split("/").pop())

  // ----------------------------
  // все транзакции
  // ----------------------------
  const allTx = dv.pages('"finance-automation/vault/finance/transactions"')

  // ==================================================
  // СВОДНАЯ ТАБЛИЦА
  // ==================================================

  const result = []

  for (let catName of selectedCatNames) {
    const tx = allTx.where(p => 
      typeof p.amount === "number" &&
      p.amount < 0 &&
      typeof p.categories === "string" &&
      p.categories.split("/").pop() === catName &&
      p.date
    )

    const byMonth = {}

    for (let t of tx) {
      const y = t.date.year
      const m = String(t.date.month).padStart(2, "0")
      const key = `${y}-${m}`
      byMonth[key] = (byMonth[key] || 0) + Math.abs(t.amount)
    }

    for (let [ym, sum] of Object.entries(byMonth).sort()) {
      result.push([
        catName.replace(".md", ""),
        ym,
        Math.round(sum)
      ])
    }
  }

  dv.header(2, "Расходы по категориям и месяцам")
  dv.table(["Категория", "Месяц", "Сумма"], result)


  // ==================================================
  // ДЕТАЛЬНЫЕ ТАБЛИЦЫ + ГРАФИКИ
  // ==================================================

  for (let catName of selectedCatNames) {
    dv.paragraph("")
    dv.paragraph("")
    const catTitle = catName.replace(".md", "")
    dv.header(2, `Категория: ${catTitle}`)

    const tx = allTx.where(p =>
      typeof p.amount === "number" &&
      p.amount < 0 &&
      typeof p.categories === "string" &&
      p.categories.split("/").pop() === catName &&
      p.date
    ).sort(p => p.date, "asc")

    const byMonth = {}

    for (let t of tx) {
      const y = t.date.year
      const m = String(t.date.month).padStart(2, "0")
      const key = `${y}-${m}`
      byMonth[key] ??= []
      byMonth[key].push(t)
    }

    const monthSums = {}

    for (let [ym, items] of Object.entries(byMonth).sort()) {
      const [y, m] = ym.split("-")
      const monthName = new Date(y, m - 1)
        .toLocaleString("ru-RU", { month: "long" })

      dv.header(3, `${monthName.charAt(0).toUpperCase() + monthName.slice(1)} ${y}`)

      dv.table(
        ["Дата", "Описание", "Сумма"],
        items.map(t => [
          t.date.toFormat("dd.MM"),
          t.description ?? t.file.name,
          Math.abs(t.amount)
        ])
      )

      monthSums[ym] = items.reduce((s, t) => s + Math.abs(t.amount), 0)
    }

    dv.header(3, `Динамика трат по категории ${catTitle}`)

    const months = Object.keys(monthSums).sort()

    dv.table(
      months.map(m => m.replace("-", ".")),
      [months.map(m => Math.round(monthSums[m]))]
    )

    // ----------------------------
    // график Chart.js
    // ----------------------------
    if (!window.Chart) {
      const script = document.createElement("script")
      script.src = "https://cdn.jsdelivr.net/npm/chart.js"
      document.head.appendChild(script)
      await new Promise(resolve => script.onload = resolve)
    }

    const labels = months.map(m => m.replace("-", "."))
    const values = months.map(m => Math.round(monthSums[m]))

    const canvas = this.container.createEl("canvas")
    canvas.style.maxWidth = "800px"
    canvas.style.marginBottom = "2em"

    new Chart(canvas, {
      type: "line",
      data: {
        labels,
        datasets: [{
          label: `Динамика трат — ${catTitle}`,
          data: values,
          tension: 0.3,
          fill: false,
          borderColor: "blue",
          backgroundColor: "lightblue"
        }]
      },
      options: {
        responsive: true,
        plugins: { legend: { display: true } },
        scales: { y: { beginAtZero: true } }
      }
    })
  }
})()

```
