---
view: monthly
categories:
  - "[[Переводы]]"
  - "[[Спорттовары]]"
  - "[[Тренировки]]"
  - "[[Супермаркеты]]"
  - "[[Фастфуд]]"
  - "[[Рестораны]]"
tags:
  - all
---

```dataviewjs
(async () => {
  // ----------------------------
  // определяем категории
  // ----------------------------
  let selectedCatNames

  if (dv.current().tags?.includes("all")) {
    // берём все уникальные категории из всех транзакций
    const allTx = dv.pages('"finance-automation/vault/finance/transactions"')
    const catSet = new Set()
    for (let t of allTx) {
      if (typeof t.categories === "string") {
        catSet.add(t.categories.split("/").pop())
      }
    }
    selectedCatNames = [...catSet]
  } else {
    // только категории из текущей заметки
    selectedCatNames = dv.array(dv.current().categories)
      .map(c => c.path.split("/").pop())
  }

  // ----------------------------
  // все транзакции
  // ----------------------------
  const allTx = dv.pages('"finance-automation/vault/finance/transactions"')

  // ----------------------------
  // подключаем Chart.js через CDN
  // ----------------------------
  if (!window.Chart) {
    const script = document.createElement("script")
    script.src = "https://cdn.jsdelivr.net/npm/chart.js"
    document.head.appendChild(script)
    await new Promise(resolve => script.onload = resolve)
  }

  // ----------------------------
  // цикл по категориям
  // ----------------------------
  for (let catName of selectedCatNames) {
    const catTitle = catName.replace(".md", "")

    // отбираем транзакции по категории и отрицательной сумме
    const tx = allTx.where(p =>
      typeof p.amount === "number" &&
      p.amount < 0 &&
      typeof p.categories === "string" &&
      p.categories.split("/").pop() === catName &&
      p.date
    )

    // агрегируем по месяцам YYYY-MM
    const monthSums = {}
    for (let t of tx) {
      const y = t.date.year
      const m = String(t.date.month).padStart(2, "0")
      const key = `${y}-${m}`
      monthSums[key] = (monthSums[key] || 0) + Math.abs(t.amount)
    }

    const months = Object.keys(monthSums).sort()
    const values = months.map(m => Math.round(monthSums[m]))
    const labels = months.map(m => m.replace("-", "."))

    // ----------------------------
    // создаём заголовок категории
    // ----------------------------
    dv.header(2, `График: ${catTitle}`)

    // ----------------------------
    // создаём canvas для Chart.js
    // ----------------------------
    const canvas = this.container.createEl("canvas")
    canvas.style.maxWidth = "800px"
    canvas.style.marginBottom = "2em"

    // ----------------------------
    // строим график
    // ----------------------------
    new Chart(canvas, {
      type: "line",
      data: {
        labels,
        datasets: [{
          label: `Динамика трат — ${catTitle}`,
          data: values,
          tension: 0.3,
          fill: false,
          borderColor: "blue",
          backgroundColor: "lightblue",
          pointRadius: 4
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: { display: true }
        },
        scales: {
          y: { beginAtZero: true }
        }
      }
    })
  }
})()

```
